"use strict";(self.webpackChunkflomesh_load_balancer=self.webpackChunkflomesh_load_balancer||[]).push([[3817],{28045:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){var core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(57658),core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0__),lodash__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(96486),lodash__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(lodash__WEBPACK_IMPORTED_MODULE_1__),_components_editor_JsonEditor__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(21936);const columns=[{key:"Span Id",dataIndex:"spanId",width:150},{key:"Service",dataIndex:"svcName",width:150},{key:"Pod",dataIndex:"podName",width:150},{key:"Count",dataIndex:"cnt",width:70},{key:"Duration",dataIndex:"duration",width:150},{key:"Waterfall",dataIndex:"waterfall"}];__webpack_exports__.Z={name:"NetworkDetail",i18n:__webpack_require__(89234),components:{JsonEditor:_components_editor_JsonEditor__WEBPACK_IMPORTED_MODULE_2__.Z},props:{},data(){return{traceId:"",loading:!0,log:"{}",visible:!1,duration:0,time:"",spans:[],columns:columns}},computed:{dataColumns(){return this.columns.map((e=>(e.title=this.$t(e.key),e)))}},created(){this.traceId=this.$route.params.id||"",this.traceId?(this.loading=!0,this.getData()):this.loading=!1},methods:{afterVisibleChange(e){},showDrawer(e){this.getLog(e),this.visible=!0},onClose(){this.visible=!1},getStep(e){return Math.ceil(e/this.duration*100)},getTime(e){return e+"ms"},buildSpan(lastduration,node,nodes,ending){let _start=node[6]-this.time,_n={key:node[0],spanId:node[0],cnt:node[2],svcName:node[3].indexOf("[")>=0?lodash__WEBPACK_IMPORTED_MODULE_1___default().uniq(eval(node[3])):[node[3]],podName:node[4].indexOf("[")>=0?lodash__WEBPACK_IMPORTED_MODULE_1___default().uniq(eval(node[4])):[node[4]],duration:node[5],reqTime:node[6],resTime:node[7],start:this.getStep(_start),end:this.getStep(_start+1*node[5]),startTime:this.getTime(_start),endTime:this.getTime(_start+1*node[5]),marks:{}};if(_n.marks[this.getStep(_start)]=this.getTime(_start),_n.marks[this.getStep(1*_start+1*node[5])]=this.getTime(1*_start+1*node[5]),!ending){let e=this.getChild({start:_start},node[0],nodes);e&&e.length>0?_n.children=e:this.getChildSpan({start:_start},_n)}return lastduration.start=node[5],_n},getChild(e,t,a){let s=[];return a?(a.forEach((a=>{let i=a.split("\t");i[0]&&""!=t&&t==i[1]&&s.push(this.buildSpan(e,i))})),s):[]},getEndChild(e,t){let a=[];return t.forEach((t=>{let s=t.split("\t");s[0]&&a.push(this.buildSpan(e,s,null,!0))})),a},setSpan(e){let t={start:0};e.forEach((a=>{let s=a.split("\t");(s[0]&&!s[1]||""==s[1])&&this.spans.push(this.buildSpan(t,s,e))}))},getLog(e){let t=`select message from log where trace.span='${e}';`;this.$request(this.$REST.CLICKHOUSE.QUERY(t),this.$METHOD.GET).then((e=>{if("object"==typeof e.data)this.log=JSON.stringify(e.data);else{let t=[];e.data.split("\n").map((e=>(e&&""!=e&&t.push(JSON.parse(e.replaceAll('\\"','"'))),e))),this.log=JSON.stringify(t)}})).catch((e=>{}))},getData(){let e=`select trace.id,count(),(max(resTime) - min(reqTime)) as duration,min(reqTime) from log where trace.id='${this.traceId}' group by trace.id;`;this.$request(this.$REST.CLICKHOUSE.QUERY(e),this.$METHOD.GET).then((e=>{e.data.split("\n").map((e=>{let t=e.split("\t");return t[0]&&(this.duration=t[2],this.time=t[3]),e})),this.getSpan()})).catch((e=>{}))},getSpan(){let e=`select trace.span,max(trace.parent),count(),groupArray(service.name),groupArray(pod.name),(max(resTime) - min(reqTime)) as duration,min(reqTime) as minreqTime,max(resTime) from log where trace.id='${this.traceId}' group by trace.span  order by minreqTime asc;`;this.$request(this.$REST.CLICKHOUSE.QUERY(e),this.$METHOD.GET).then((e=>{let t=e.data.split("\n");this.setSpan(t)})).catch((e=>{}))},getChildSpan(e,t){let a=`select trace.span,trace.parent,1,service.name,pod.name,(resTime - reqTime) as duration,reqTime,resTime from log where trace.id='${this.traceId}' and trace.span='${t.spanId}' order by reqTime asc;`;this.$request(this.$REST.CLICKHOUSE.QUERY(a),this.$METHOD.GET).then((a=>{let s=0,i=a.data.split("\n");if(i.forEach((e=>{e.split("\t")[0]&&s++})),s>1){t.children=[],this.getEndChild(e,i).forEach((e=>{t.children.push(e)})),this.spans=lodash__WEBPACK_IMPORTED_MODULE_1___default().cloneDeep(this.spans)}})).catch((e=>{}))}}}},93817:function(e,t,a){a.r(t),a.d(t,{default:function(){return u}});var s=a(66252),i=a(3577);const r={class:"network-card-header"},n={class:"network-card-body"},_={key:0,class:"inline-block"},d=["onClick"],l={key:1},o={key:4,class:"waterfall-panel"},c={class:"pr-15"};var h=a(28045);var u=(0,a(83744).Z)(h.Z,[["render",function(e,t,a,h,u,p){const m=(0,s.up)("JsonEditor"),g=(0,s.up)("a-drawer"),E=(0,s.up)("a-tag"),w=(0,s.up)("a-slider"),f=(0,s.up)("a-table"),T=(0,s.up)("a-card");return(0,s.wg)(),(0,s.j4)(T,{class:"card nopd",title:e.$t("Waterfall Detail")},{default:(0,s.w5)((()=>[(0,s._)("div",r,[(0,s._)("h2",null,"Trace ID : "+(0,i.zw)(u.traceId),1)]),(0,s._)("div",n,[u.visible?((0,s.wg)(),(0,s.j4)(g,{key:0,"get-container":!1,title:e.$t("log"),placement:"right",width:"700",closable:!1,visible:u.visible,"wrap-style":{position:"absolute"},"after-visible-change":p.afterVisibleChange,onClose:p.onClose},{default:(0,s.w5)((()=>[(0,s.Wm)(m,{"is-readonly":!0,value:u.log},null,8,["value"])])),_:1},8,["title","visible","after-visible-change","onClose"])):(0,s.kq)("",!0),(0,s.Wm)(f,{columns:p.dataColumns,"data-source":u.spans,pagination:!1},{bodyCell:(0,s.w5)((({column:e,record:t})=>["spanId"===e.dataIndex?((0,s.wg)(),(0,s.iD)("div",_,[(0,s._)("a",{href:"javascript:void(0)",onClick:e=>p.showDrawer(t.spanId)},(0,i.zw)(t.spanId),9,d)])):"duration"===e.dataIndex?((0,s.wg)(),(0,s.iD)("div",l,(0,i.zw)(t.duration)+" ms",1)):"svcName"===e.dataIndex?((0,s.wg)(!0),(0,s.iD)(s.HY,{key:2},(0,s.Ko)(t.svcName,((e,t)=>((0,s.wg)(),(0,s.j4)(E,{key:t},{default:(0,s.w5)((()=>[(0,s.Uk)((0,i.zw)(e),1)])),_:2},1024)))),128)):"podName"===e.dataIndex?((0,s.wg)(!0),(0,s.iD)(s.HY,{key:3},(0,s.Ko)(t.podName,((e,t)=>((0,s.wg)(),(0,s.j4)(E,{key:t},{default:(0,s.w5)((()=>[(0,s.Uk)((0,i.zw)(e),1)])),_:2},1024)))),128)):"waterfall"===e.dataIndex?((0,s.wg)(),(0,s.iD)("div",o,[(0,s._)("div",c,[(0,s.Wm)(w,{marks:t.marks,class:"waterfall",range:"","default-value":[t.start,t.end]},null,8,["marks","default-value"])])])):(0,s.kq)("",!0)])),_:1},8,["columns","data-source"])])])),_:1},8,["title"])}],["__scopeId","data-v-01b69977"]])}}]);